<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VC</title>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0f1220;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .app-container {
      background: #1e2133;
      padding: 30px;
      border-radius: 16px;
      width: 360px;
      box-shadow: 0 10px 40px rgba(0,0,0,.6);
      border: 1px solid #2f344d;
    }
    h2 { margin-top: 0; text-align:center; }
    .badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 10px;
      background: #333;
    }
    .badge.host { background:#43b581 }
    .badge.client { background:#faa61a }
    .status { font-size:13px; color:#a0a5bd; text-align:center }
    .controls { margin-top:20px; display:flex; gap:10px }
    .btn { flex:1; padding:12px; border-radius:8px; border:none; font-weight:bold; cursor:pointer }
    .btn-primary { background:#5865F2; color:#fff }
    .btn-danger { background:#ed4245; color:#fff }
    .user-list { margin-top:20px; background:#151824; border-radius:8px; padding:10px; min-height:80px }
    .user-item { display:flex; align-items:center; font-size:14px; padding:6px 0 }
    .dot { width:10px; height:10px; border-radius:50%; background:#43b581; margin-right:8px }
  </style>
</head>
<body>
<div class="app-container">
  <h2>Voice Channel</h2>
  <div id="status-badge" class="badge">Offline</div>
  <div id="status-text" class="status">Waiting…</div>

  <div class="user-list" id="user-list"></div>

  <div class="controls">
    <button id="btn-join" class="btn btn-primary">Join</button>
    <button id="btn-mute" class="btn btn-danger" disabled>Mute</button>
  </div>
</div>

<div id="audio-grid"></div>

<script>
const ROOM_ID = "my-voice-room-123";

let peer;
let localStream;
let connectedPeers = new Set();

const btnJoin = document.getElementById("btn-join");
const btnMute = document.getElementById("btn-mute");
const statusBadge = document.getElementById("status-badge");
const statusText = document.getElementById("status-text");
const userList = document.getElementById("user-list");

btnJoin.onclick = async () => {
  btnJoin.disabled = true;
  statusText.textContent = "Requesting microphone…";

  try {
    localStream = await navigator.mediaDevices.getUserMedia({ audio:true });
    btnMute.disabled = false;
    initPeer();
  } catch {
    statusText.textContent = "Microphone denied";
    btnJoin.disabled = false;
  }
};

function initPeer(){
  peer = new Peer(ROOM_ID);

  peer.on("open", id => {
    setUI("HOST", id);
    setupHost();
  });

  peer.on("error", err => {
    if(err.type === "unavailable-id"){
      peer = new Peer();
      peer.on("open", id => {
        setUI("CLIENT", id);
        setupClient();
      });
    }
  });
}

function setupHost(){
  peer.on("call", call => {
    call.answer(localStream);
    attachAudio(call);
  });

  peer.on("connection", conn => {
    connectedPeers.add(conn.peer);
    conn.send({ peers:[...connectedPeers] });

    conn.on("close", () => connectedPeers.delete(conn.peer));
  });
}

function setupClient(){
  const conn = peer.connect(ROOM_ID);

  conn.on("open", () => {
    const hostCall = peer.call(ROOM_ID, localStream);
    attachAudio(hostCall);
  });

  conn.on("data", data => {
    data.peers.forEach(id => {
      if(id !== peer.id){
        const call = peer.call(id, localStream);
        attachAudio(call);
      }
    });
  });

  peer.on("call", call => {
    call.answer(localStream);
    attachAudio(call);
  });
}

function attachAudio(call){
  call.on("stream", stream => {
    if(document.getElementById("audio-"+call.peer)) return;

    const audio = document.createElement("audio");
    audio.id = "audio-"+call.peer;
    audio.srcObject = stream;
    audio.playsInline = true;
    document.getElementById("audio-grid").appendChild(audio);

    audio.play().catch(()=>{});
    addUser(call.peer);
  });

  call.on("close", () => removeUser(call.peer));
}

btnMute.onclick = () => {
  const track = localStream.getAudioTracks()[0];
  track.enabled = !track.enabled;
  btnMute.textContent = track.enabled ? "Mute" : "Unmute";
};

function setUI(role,id){
  statusBadge.textContent = role;
  statusBadge.className = "badge "+role.toLowerCase();
  statusText.textContent = "Connected as "+id;
  userList.innerHTML = "";
  addUser("You");
  btnJoin.style.display = "none";
}

function addUser(id){
  if(document.getElementById("ui-"+id)) return;
  const div = document.createElement("div");
  div.className = "user-item";
  div.id = "ui-"+id;
  div.innerHTML = `<div class='dot'></div> ${id}`;
  userList.appendChild(div);
}

function removeUser(id){
  document.getElementById("ui-"+id)?.remove();
  document.getElementById("audio-"+id)?.remove();
}
</script>
</body>
</html>
